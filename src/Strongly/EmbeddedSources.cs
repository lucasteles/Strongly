using System;
using System.IO;
using System.Reflection;
using System.Text;

namespace Strongly;

static class EmbeddedSources
{
    static readonly Assembly ThisAssembly = typeof(EmbeddedSources).Assembly;
    const string TemplateNamespace = "Strongly.Templates.";

    internal static readonly string StronglyAttributeSource =
        LoadTemplateForEmitting("StronglyAttribute");

    internal static readonly string StronglyDefaultsAttributeSource =
        LoadTemplateForEmitting("StronglyDefaultsAttribute");

    internal static readonly string StronglyBackingTypeSource =
        LoadTemplateForEmitting("StronglyType");

    internal static readonly string StronglyConverterSource =
        LoadTemplateForEmitting("StronglyConverter");

    internal static readonly string StronglyImplementationsSource =
        LoadTemplateForEmitting("StronglyImplementations");

    static readonly string AutoGeneratedHeader =
        LoadEmbeddedResource("AutoGeneratedHeader");

    internal static readonly ResourceCollection SequentialGuidResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("SequentialGuid.SequentialGuid_Base"),
        LoadEmbeddedResource("Guid.Guid_NewtonsoftJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_SystemTextJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_TypeConverter"),
        LoadEmbeddedResource("Guid.Guid_EfValueConverter"),
        LoadEmbeddedResource("Guid.Guid_DapperTypeHandler"),
        LoadEmbeddedResource("Guid.Guid_IComparable"),
        LoadEmbeddedResource("Guid.Guid_SwaggerSchemaFilter"),
        LoadEmbeddedResource("Guid.Guid_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection GuidComb = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("GuidComb.GuidComb_Base"),
        LoadEmbeddedResource("Guid.Guid_NewtonsoftJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_SystemTextJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_TypeConverter"),
        LoadEmbeddedResource("Guid.Guid_EfValueConverter"),
        LoadEmbeddedResource("Guid.Guid_DapperTypeHandler"),
        LoadEmbeddedResource("Guid.Guid_IComparable"),
        LoadEmbeddedResource("Guid.Guid_SwaggerSchemaFilter"),
        LoadEmbeddedResource("Guid.Guid_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection GuidResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("Guid.Guid_Base"),
        LoadEmbeddedResource("Guid.Guid_NewtonsoftJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_SystemTextJsonConverter"),
        LoadEmbeddedResource("Guid.Guid_TypeConverter"),
        LoadEmbeddedResource("Guid.Guid_EfValueConverter"),
        LoadEmbeddedResource("Guid.Guid_DapperTypeHandler"),
        LoadEmbeddedResource("Guid.Guid_IComparable"),
        LoadEmbeddedResource("Guid.Guid_SwaggerSchemaFilter"),
        LoadEmbeddedResource("Guid.Guid_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection IntResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("Int.Int_Base"),
        LoadEmbeddedResource("Int.Int_NewtonsoftJsonConverter"),
        LoadEmbeddedResource("Int.Int_SystemTextJsonConverter"),
        LoadEmbeddedResource("Int.Int_TypeConverter"),
        LoadEmbeddedResource("Int.Int_EfValueConverter"),
        LoadEmbeddedResource("Int.Int_DapperTypeHandler"),
        LoadEmbeddedResource("Int.Int_IComparable"),
        LoadEmbeddedResource("Int.Int_SwaggerSchemaFilter"),
        LoadEmbeddedResource("Int.Int_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection LongResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("Long.Long_Base"),
        LoadEmbeddedResource("Long.Long_NewtonsoftJsonConverter"),
        LoadEmbeddedResource("Long.Long_SystemTextJsonConverter"),
        LoadEmbeddedResource("Long.Long_TypeConverter"),
        LoadEmbeddedResource("Long.Long_EfValueConverter"),
        LoadEmbeddedResource("Long.Long_DapperTypeHandler"),
        LoadEmbeddedResource("Long.Long_IComparable"),
        LoadEmbeddedResource("Long.Long_SwaggerSchemaFilter"),
        LoadEmbeddedResource("Long.Long_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection BigIntegerResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("BigInteger.BigInteger_Base"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_NewtonsoftJsonConverter"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_SystemTextJsonConverter"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_TypeConverter"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_EfValueConverter"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_DapperTypeHandler"),
        LoadEmbeddedResource("BigInteger.BigInteger_IComparable"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_SwaggerSchemaFilter"),
        LoadEmbeddedResource(
            "BigInteger.BigInteger_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection DecimalResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("Decimal.Decimal_Base"),
        LoadEmbeddedResource(
            "Decimal.Decimal_NewtonsoftJsonConverter"),
        LoadEmbeddedResource(
            "Decimal.Decimal_SystemTextJsonConverter"),
        LoadEmbeddedResource("Decimal.Decimal_TypeConverter"),
        LoadEmbeddedResource(
            "Decimal.Decimal_EfValueConverter"),
        LoadEmbeddedResource("Decimal.Decimal_DapperTypeHandler"),
        LoadEmbeddedResource("Decimal.Decimal_IComparable"),
        LoadEmbeddedResource(
            "Decimal.Decimal_SwaggerSchemaFilter"),
        LoadEmbeddedResource(
            "Decimal.Decimal_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection StringResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("String.String_Base"),
        LoadEmbeddedResource(
            "String.String_NewtonsoftJsonConverter"),
        LoadEmbeddedResource(
            "String.String_SystemTextJsonConverter"),
        LoadEmbeddedResource("String.String_TypeConverter"),
        LoadEmbeddedResource(
            "String.String_EfValueConverter"),
        LoadEmbeddedResource("String.String_DapperTypeHandler"),
        LoadEmbeddedResource("String.String_IComparable"),
        LoadEmbeddedResource("String.String_SwaggerSchemaFilter"),
        LoadEmbeddedResource("String.String_Parsable"),
        NullableEnable: false
    );

    internal static readonly ResourceCollection NullableStringResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource(
            "NullableString.NullableString_Base"),
        LoadEmbeddedResource(
            "NullableString.NullableString_NewtonsoftJsonConverter"),
        LoadEmbeddedResource(
            "NullableString.NullableString_SystemTextJsonConverter"),
        LoadEmbeddedResource(
            "NullableString.NullableString_TypeConverter"),
        LoadEmbeddedResource(
            "NullableString.NullableString_EfValueConverter"),
        LoadEmbeddedResource(
            "NullableString.NullableString_DapperTypeHandler"),
        LoadEmbeddedResource(
            "NullableString.NullableString_IComparable"),
        LoadEmbeddedResource(
            "NullableString.NullableString_SwaggerSchemaFilter"),
        LoadEmbeddedResource(
            "NullableString.NullableString_Parsable"),
        NullableEnable: true
    );

    internal static readonly ResourceCollection NewIdResources = new(
        AutoGeneratedHeader,
        LoadEmbeddedResource("NewId.NewId_Base"),
        LoadEmbeddedResource(
            "NewId.NewId_NewtonsoftJsonConverter"),
        LoadEmbeddedResource(
            "NewId.NewId_SystemTextJsonConverter"),
        LoadEmbeddedResource("NewId.NewId_TypeConverter"),
        LoadEmbeddedResource("NewId.NewId_EfValueConverter"),
        LoadEmbeddedResource("NewId.NewId_DapperTypeHandler"),
        LoadEmbeddedResource("NewId.NewId_IComparable"),
        LoadEmbeddedResource("NewId.NewId_SwaggerSchemaFilter"),
        LoadEmbeddedResource("NewId.NewId_Parsable"),
        NullableEnable: false
    );

    internal const string TypeConverterAttributeSource =
        "    [System.ComponentModel.TypeConverter(typeof(TYPENAMETypeConverter))]";

    internal const string NewtonsoftJsonAttributeSource =
        "    [Newtonsoft.Json.JsonConverter(typeof(TYPENAMENewtonsoftJsonConverter))]";

    internal const string SystemTextJsonAttributeSource =
        "    [System.Text.Json.Serialization.JsonConverter(typeof(TYPENAMESystemTextJsonConverter))]";

    internal const string SwaggerSchemaFilterAttributeSource =
        "    [Swashbuckle.AspNetCore.Annotations.SwaggerSchemaFilter(typeof(TYPENAMESchemaFilter))]";

    internal static string LoadEmbeddedResource(string resourceTemplateName)
    {
        var resourceName = $"{TemplateNamespace}{resourceTemplateName}.cs";
        var resourceStream = ThisAssembly.GetManifestResourceStream(resourceName);
        if (resourceStream is null)
        {
            var existingResources = ThisAssembly.GetManifestResourceNames();
            throw new ArgumentException(
                $"Could not find embedded resource {resourceName}. Available names: {string.Join(", ", existingResources)}");
        }

        using var reader = new StreamReader(resourceStream, Encoding.UTF8);

        return reader.ReadToEnd();
    }

    public readonly record struct ResourceCollection(
        string Header,
        string Base,
        string Newtonsoft,
        string SystemTextJson,
        string TypeConverter,
        string EfValueConverter,
        string DapperTypeHandler,
        string Comparable,
        string SwaggerSchemaFilter,
        string Parsable,
        bool NullableEnable
    );

    internal static string LoadTemplateForEmitting(string resourceName)
    {
        var resource = LoadEmbeddedResource($"Sources.{resourceName}");
        return AutoGeneratedHeader + @"#if STRONGLY_TYPED_EMBED_ATTRIBUTES

" + resource
                   .Replace("public sealed", "internal sealed")
                   .Replace("public enum", "internal enum")
               + @"
#endif";
    }
}